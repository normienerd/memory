<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mone Rakhi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'media',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    /* Custom Scrollbar for a cleaner look */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    
    /* Safe area utilities for iOS */
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    
    /* Animations */
    @keyframes bounce {
      0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8,0,1,1); }
      50% { transform: none; animation-timing-function: cubic-bezier(0,0,0.2,1); }
    }
    .animate-bounce { animation: bounce 1s infinite; }
    .delay-75 { animation-delay: 75ms; }
    .delay-150 { animation-delay: 150ms; }
  </style>
</head>
<body class="flex justify-center bg-slate-100 dark:bg-slate-950 min-h-screen font-sans selection:bg-teal-200 dark:selection:bg-teal-900 transition-colors duration-300 overflow-hidden">

  <div class="w-full max-w-md bg-white dark:bg-slate-900 shadow-2xl h-screen flex flex-col overflow-hidden sm:h-[90vh] sm:mt-[5vh] sm:rounded-[2.5rem] sm:border sm:border-slate-200 dark:sm:border-slate-800 relative transition-colors duration-300">
    
    <!-- Header -->
    <header class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md z-10 flex-none flex items-center justify-between transition-colors duration-300">
      <div class="flex items-center space-x-3">
        <div class="w-9 h-9 bg-teal-600 rounded-full flex items-center justify-center shadow-sm text-white">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/></svg>
        </div>
        <h1 class="text-xl font-semibold text-slate-800 dark:text-slate-100 tracking-tight transition-colors duration-300">Mone Rakhi</h1>
      </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 overflow-hidden bg-[#FAFAFA] dark:bg-[#0f172a] relative transition-colors duration-300">
      
      <!-- Chat View -->
      <div id="chat-view" class="flex flex-col h-full relative">
        <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-5">
          <!-- Messages injected via JS -->
        </div>

        <div class="flex-none p-4 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 shadow-[0_-2px_15px_rgba(0,0,0,0.02)] transition-colors duration-300">
          <form id="chat-form" class="flex items-center space-x-3 bg-slate-100 dark:bg-slate-800 rounded-full p-1.5 pl-5 transition-all duration-300 focus-within:ring-2 focus-within:ring-teal-100 dark:focus-within:ring-teal-900/50 focus-within:bg-white dark:focus-within:bg-slate-900 border border-transparent focus-within:border-teal-200 dark:focus-within:border-teal-700/50">
            <input
              type="text"
              id="chat-input"
              placeholder="Tell me what to remember..."
              autocomplete="off"
              class="flex-1 bg-transparent outline-none text-slate-700 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 text-[15px]"
            />
            <button 
              type="submit" 
              id="chat-submit"
              disabled
              class="p-2.5 bg-teal-600 text-white rounded-full disabled:bg-teal-300 dark:disabled:bg-teal-800 disabled:opacity-70 transition-all hover:bg-teal-700"
            >
              <svg class="translate-x-[1px] translate-y-[1px]" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </button>
          </form>
        </div>
      </div>

      <!-- Vault View -->
      <div id="vault-view" class="h-full overflow-y-auto p-6 space-y-8 hidden">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-2xl font-semibold text-slate-800 dark:text-slate-100 tracking-tight transition-colors duration-300">Memory Vault</h2>
          <span id="vault-count" class="text-xs font-semibold text-teal-600 dark:text-teal-400 bg-teal-50 dark:bg-teal-900/30 px-2.5 py-1 rounded-md transition-colors duration-300">0 Items</span>
        </div>
        <div id="vault-content">
            <!-- Vault Sections injected via JS -->
        </div>
      </div>

      <!-- Calendar View -->
      <div id="calendar-view" class="h-full flex flex-col overflow-hidden hidden">
        <div class="p-6 pb-2 flex-none">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-slate-800 dark:text-slate-100 tracking-tight transition-colors duration-300">Calendar</h2>
            <div class="flex space-x-2">
              <button id="cal-prev" class="p-2 rounded-full bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 shadow-sm border border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
              </button>
              <button id="cal-next" class="p-2 rounded-full bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 shadow-sm border border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
              </button>
            </div>
          </div>
          
          <div id="cal-month-year" class="mb-4 text-lg font-medium text-slate-700 dark:text-slate-200 transition-colors duration-300">
            <!-- Month Year injected -->
          </div>
  
          <div class="grid grid-cols-7 gap-1 mb-2">
            <div class="text-center text-[11px] font-bold tracking-wider text-slate-400 dark:text-slate-500 uppercase transition-colors duration-300">Sun</div>
            <div class="text-center text-[11px] font-bold tracking-wider text-slate-400 dark:text-slate-500 uppercase transition-colors duration-300">Mon</div>
            <div class="text-center text-[11px] font-bold tracking-wider text-slate-400 dark:text-slate-500 uppercase transition-colors duration-300">Tue</div>
            <div class="text-center text-[11px] font-bold tracking-wider text-slate-400 dark:text-slate-500 uppercase transition-colors duration-300">Wed</div>
            <div class="text-center text-[11px] font-bold tracking-wider text-slate-400 dark:text-slate-500 uppercase transition-colors duration-300">Thu</div>
            <div class="text-center text-[11px] font-bold tracking-wider text-slate-400 dark:text-slate-500 uppercase transition-colors duration-300">Fri</div>
            <div class="text-center text-[11px] font-bold tracking-wider text-slate-400 dark:text-slate-500 uppercase transition-colors duration-300">Sat</div>
          </div>
          
          <div id="cal-grid" class="grid grid-cols-7 gap-y-1 gap-x-1">
            <!-- Calendar Days injected via JS -->
          </div>
        </div>
  
        <div class="flex-1 overflow-y-auto p-6 pt-4 border-t border-slate-100 dark:border-slate-800 mt-2 bg-slate-50/50 dark:bg-[#0f172a] transition-colors duration-300">
          <h3 id="cal-selected-date-text" class="text-[13px] font-semibold text-slate-500 dark:text-slate-400 mb-4 transition-colors duration-300">
            <!-- Selected Date text -->
          </h3>
          
          <div id="cal-agenda-content">
            <!-- Agenda items injected via JS -->
          </div>
        </div>
      </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="flex-none bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 flex justify-around py-2 pb-safe shadow-[0_-4px_20px_rgba(0,0,0,0.02)] z-10 transition-colors duration-300">
      <button onclick="switchTab('chat')" id="nav-chat" class="nav-btn text-teal-600 dark:text-teal-400 flex flex-col items-center justify-center w-20 h-14 transition-colors duration-300">
        <svg class="icon-stroke stroke-[2.5px]" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
        <span class="text-[11px] font-medium mt-1.5">Assistant</span>
      </button>
      <button onclick="switchTab('vault')" id="nav-vault" class="nav-btn text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 flex flex-col items-center justify-center w-20 h-14 transition-colors duration-300">
        <svg class="icon-stroke stroke-2" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
        <span class="text-[11px] font-medium mt-1.5">Vault</span>
      </button>
      <button onclick="switchTab('calendar')" id="nav-calendar" class="nav-btn text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 flex flex-col items-center justify-center w-20 h-14 transition-colors duration-300">
        <svg class="icon-stroke stroke-2" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
        <span class="text-[11px] font-medium mt-1.5">Calendar</span>
      </button>
    </nav>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Application State
    let activeTab = 'chat';
    let messages = [
      { role: 'ai', text: "Ami apnar memory assistant. Ki mone rakhte hobe bolen, ami guchiye rakhbo." }
    ];
    let memories = [];
    let isThinking = false;
    let currentUser = null;
    let currentDate = new Date();
    let selectedDate = new Date();

    // Icons Mapping for injecting SVGs dynamically
    const SVG_CIRCLE = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>`;
    const SVG_CHECKED = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>`;
    const SVG_FILETEXT = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`;
    const SVG_CLOCK = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`;
    const SVG_INBOX_EMPTY = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>`;
    const SVG_CALENDAR_EMPTY = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`;

    // Firebase Setup
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Firebase auth error:", error);
      }
    };
    initAuth();

    let unsubscribeSnapshot = null;

    onAuthStateChanged(auth, (u) => {
      currentUser = u;
      if (currentUser) {
        const memoriesRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'memories');
        unsubscribeSnapshot = onSnapshot(memoriesRef, (snapshot) => {
          const fetchedMemories = [];
          snapshot.forEach((document) => {
            fetchedMemories.push({ id: document.id, ...document.data() });
          });
          fetchedMemories.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          memories = fetchedMemories;
          
          if (activeTab === 'vault') renderVault();
          if (activeTab === 'calendar') renderCalendar();
        }, (error) => {
          console.error("Firestore error:", error);
        });
      }
    });

    // Toggle Memory Handler (Delegated to window for generic use)
    window.toggleMemory = async (id) => {
      if (!currentUser) return;
      const memory = memories.find(m => m.id === id);
      if (memory) {
        await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'memories', id), { completed: !memory.completed }, { merge: true });
      }
    };

    // Tab Switching
    window.switchTab = (tab) => {
      activeTab = tab;
      
      // Update Nav active classes
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('text-teal-600', 'dark:text-teal-400');
        btn.classList.add('text-slate-400', 'dark:text-slate-500');
        btn.querySelector('.icon-stroke').classList.remove('stroke-[2.5px]');
        btn.querySelector('.icon-stroke').classList.add('stroke-2');
      });
      const activeBtn = document.getElementById(`nav-${tab}`);
      activeBtn.classList.add('text-teal-600', 'dark:text-teal-400');
      activeBtn.classList.remove('text-slate-400', 'dark:text-slate-500');
      activeBtn.querySelector('.icon-stroke').classList.add('stroke-[2.5px]');
      activeBtn.querySelector('.icon-stroke').classList.remove('stroke-2');

      // Update Views
      document.getElementById('chat-view').classList.add('hidden');
      document.getElementById('vault-view').classList.add('hidden');
      document.getElementById('calendar-view').classList.add('hidden');
      document.getElementById(`${tab}-view`).classList.remove('hidden');

      if (tab === 'chat') {
        renderChat();
        setTimeout(() => scrollToBottom(), 10);
      } else if (tab === 'vault') {
        renderVault();
      } else if (tab === 'calendar') {
        renderCalendar();
      }
    };

    // Render Chat View
    function renderChat() {
      const container = document.getElementById('chat-messages');
      
      let html = `
        <div class="text-center mb-6 mt-4">
          <span class="text-xs font-medium text-slate-400 dark:text-slate-500 bg-slate-100 dark:bg-slate-800/50 px-3 py-1 rounded-full uppercase tracking-widest transition-colors duration-300">Today</span>
        </div>
      `;

      messages.forEach(m => {
        const isUser = m.role === 'user';
        const wrapperClass = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
        const bubbleClass = `max-w-[85%] p-3.5 text-[15px] leading-relaxed rounded-2xl transition-colors duration-300 ${
          isUser 
            ? 'bg-teal-600 text-white rounded-br-sm shadow-sm' 
            : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 shadow-sm border border-slate-100 dark:border-slate-700 rounded-bl-sm'
        }`;
        
        html += `
          <div class="${wrapperClass}">
            <div class="${bubbleClass}">
              ${escapeHtml(m.text)}
            </div>
          </div>
        `;
      });

      if (isThinking) {
        html += `
          <div class="flex justify-start">
            <div class="max-w-[80%] p-4 rounded-2xl bg-white dark:bg-slate-800 shadow-sm border border-slate-100 dark:border-slate-700 rounded-bl-sm flex space-x-1.5 items-center transition-colors duration-300">
              <div class="w-2 h-2 bg-slate-300 dark:bg-slate-500 rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-slate-300 dark:bg-slate-500 rounded-full animate-bounce delay-75"></div>
              <div class="w-2 h-2 bg-slate-300 dark:bg-slate-500 rounded-full animate-bounce delay-150"></div>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
      scrollToBottom();
    }

    function scrollToBottom() {
      const container = document.getElementById('chat-messages');
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    }

    // Chat Submission Logic
    const chatInput = document.getElementById('chat-input');
    const chatSubmit = document.getElementById('chat-submit');
    const chatForm = document.getElementById('chat-form');

    chatInput.addEventListener('input', () => {
      chatSubmit.disabled = !chatInput.value.trim() || isThinking;
    });

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text || isThinking) return;

      chatInput.value = '';
      chatSubmit.disabled = true;
      isThinking = true;
      
      messages.push({ role: 'user', text });
      renderChat();

      try {
        const apiKey = ""; // The execution environment provides this key
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const conversationHistory = messages.map(m => `${m.role === 'user' ? 'User' : 'Mone Rakhi'}: ${m.text}`).join('\n');
        const fullPrompt = `Here is the conversation so far:\n${conversationHistory}\n\nNow the user says: ${text}`;

        const payload = {
          contents: [{ parts: [{ text: fullPrompt }] }],
          systemInstruction: {
            parts: [{ text: `You are Mone Rakhi, a calm, minimalist AI memory assistant designed to reduce the user's mental load. 
Current Date/Time: ${new Date().toLocaleString()}. 
Analyze the user's latest input within the context of the conversation. 

RULES FOR EXTRACTION:
1. Extract new actionable items (reminders, tasks, notes) that the user wants you to remember.
2. DUE DATE REQUIREMENT: If the user asks you to remember a 'task' or 'reminder', check if they provided a due date/time. 
   - If NO due date is provided: DO NOT add the item to the 'items' array yet. Instead, use your 'ai_response' to politely ask them when it is due in casual Banglish.
   - If a due date IS provided (or if they say "no due date"), extract it into the 'items' array.
3. 'note' types do not require a due date and can be added immediately.
4. Respond directly with a brief, calming confirmation or question (under 2 sentences) in 'ai_response'.
5. Always output strictly valid JSON matching the schema.
6. LANGUAGE REQUIREMENT: You MUST communicate with the user entirely in casual, everyday "Banglish" (Bengali language written using English alphabets). Avoid overly formal words. For example: "Ami eita save kore rakhlam" or "Eita kobe mone koriye dibo?".
7. TASK REPHRASING: When saving the 'content' of a task or reminder, convert the user's first-person statement into an actionable task in Banglish. For example, if the user says "ami office e mail dibo", save the content as "Office e mail dite hobe" or "Office e mail dewa lagbe".` }]
          },
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "OBJECT",
              properties: {
                ai_response: { type: "STRING", description: "Your brief, calming conversational reply to the user." },
                items: {
                  type: "ARRAY",
                  items: {
                    type: "OBJECT",
                    properties: {
                      type: { type: "STRING", enum: ["reminder", "task", "note"] },
                      content: { type: "STRING", description: "The specific detail to remember." },
                      due_date: { type: "STRING", description: "Clear, readable date/time (e.g. 'Tomorrow at 5 PM', 'Monday') if mentioned, else null", nullable: true },
                      iso_date: { type: "STRING", description: "ISO 8601 formatted date (YYYY-MM-DD) corresponding to the due date, if applicable.", nullable: true }
                    },
                    required: ["type", "content"]
                  }
                }
              },
              required: ["ai_response", "items"]
            }
          }
        };

        const fetchWithRetry = async (retries = 5) => {
          const delays = [1000, 2000, 4000, 8000, 16000];
          for (let i = 0; i < retries; i++) {
            try {
              const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              if (!response.ok) throw new Error("API Error");
              return await response.json();
            } catch (err) {
              if (i === retries - 1) throw err;
              await new Promise(r => setTimeout(r, delays[i]));
            }
          }
        };

        const data = await fetchWithRetry();
        let responseText = data.candidates[0].content.parts[0].text;
        
        responseText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
        const parsed = JSON.parse(responseText);

        if (parsed.items && parsed.items.length > 0 && currentUser) {
          for (const item of parsed.items) {
            const memoryId = crypto.randomUUID();
            const memoryData = {
              type: item.type,
              content: item.content,
              dueDate: item.due_date,
              isoDate: item.iso_date || null,
              completed: false,
              createdAt: new Date().toISOString()
            };
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'memories', memoryId), memoryData);
          }
        }

        messages.push({ role: 'ai', text: parsed.ai_response });

      } catch (error) {
        console.error("Assistant Error:", error);
        const isReminder = text.toLowerCase().includes('remind') || text.toLowerCase().includes('tomorrow');
        const memoryId = crypto.randomUUID();
        const newItem = {
          type: isReminder ? 'reminder' : 'note',
          content: text,
          dueDate: isReminder ? 'Upcoming' : null,
          isoDate: isReminder ? new Date().toISOString().split('T')[0] : null,
          completed: false,
          createdAt: new Date().toISOString()
        };
        
        if (currentUser) {
          await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'memories', memoryId), newItem);
        }
        
        messages.push({ role: 'ai', text: "Ami eita vault e save kore rakhlam." });
      } finally {
        isThinking = false;
        renderChat();
        if(chatInput.value.trim().length > 0) {
           chatSubmit.disabled = false;
        }
      }
    });

    // Render Vault View
    function renderVault() {
      document.getElementById('vault-count').innerText = `${memories.length} Items`;
      
      const tasks = memories.filter(m => (m.type === 'task' || m.type === 'reminder') && !m.completed);
      const notes = memories.filter(m => m.type === 'note' && !m.completed);
      const completed = memories.filter(m => m.completed);

      let html = '';

      if (memories.length === 0) {
        html = `
          <div class="text-center text-slate-400 dark:text-slate-500 mt-32 flex flex-col items-center transition-colors duration-300">
            <div class="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 transition-colors duration-300 text-slate-300 dark:text-slate-600">
              ${SVG_INBOX_EMPTY}
            </div>
            <p class="text-lg font-medium text-slate-600 dark:text-slate-300">Your mind is clear.</p>
            <p class="text-sm mt-2 max-w-[200px]">Ask the assistant to remember things for you, and they will safely appear here.</p>
          </div>
        `;
      } else {
        html += renderVaultSection("To Do & Reminders", tasks);
        html += renderVaultSection("Saved Notes", notes);
        html += renderVaultSection("Completed", completed);
      }

      document.getElementById('vault-content').innerHTML = html;
    }

    function renderVaultSection(title, items) {
      if (!items || items.length === 0) return '';
      
      let html = `
        <div class="mb-8">
          <h3 class="text-[11px] font-bold tracking-widest text-slate-400 dark:text-slate-500 uppercase mb-3 px-1 transition-colors duration-300">${title}</h3>
          <div class="space-y-3">
      `;

      items.forEach(item => {
        const isActionable = item.type === 'task' || item.type === 'reminder' || item.completed;
        const baseClass = item.completed 
          ? 'opacity-50 hover:opacity-100 bg-slate-50 dark:bg-slate-800/40 border-slate-100 dark:border-slate-800' 
          : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 hover:shadow-md';
        
        let iconHtml = '';
        if (isActionable) {
          iconHtml = `
            <button onclick="toggleMemory('${item.id}')" class="mt-0.5 mr-3 text-teal-600 dark:text-teal-500 flex-shrink-0 focus:outline-none">
              ${item.completed ? `<span class="text-teal-500">${SVG_CHECKED}</span>` : `<span class="text-slate-300 dark:text-slate-600 hover:text-teal-400 dark:hover:text-teal-400 transition-colors">${SVG_CIRCLE}</span>`}
            </button>
          `;
        } else {
          iconHtml = `
            <div class="mt-0.5 mr-3 text-slate-300 dark:text-slate-600 flex-shrink-0">
              ${SVG_FILETEXT}
            </div>
          `;
        }

        const textClass = item.completed ? 'line-through text-slate-500 dark:text-slate-400' : 'text-slate-800 dark:text-slate-200';
        let dateHtml = '';
        if (item.dueDate) {
          dateHtml = `
            <div class="flex items-center text-xs font-medium text-slate-400 dark:text-slate-400 mt-2 space-x-1.5 bg-slate-50 dark:bg-slate-700/50 inline-flex px-2 py-0.5 rounded-md transition-colors duration-300">
              ${SVG_CLOCK}
              <span>${escapeHtml(item.dueDate)}</span>
            </div>
          `;
        }

        html += `
          <div class="group flex items-start p-4 rounded-2xl border shadow-sm transition-all duration-300 ${baseClass}">
            ${iconHtml}
            <div class="flex-1 min-w-0 pr-2">
              <p class="text-[15px] leading-snug break-words transition-colors duration-300 ${textClass}">
                ${escapeHtml(item.content)}
              </p>
              ${dateHtml}
            </div>
          </div>
        `;
      });

      html += `</div></div>`;
      return html;
    }

    // Render Calendar View
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    
    document.getElementById('cal-prev').addEventListener('click', () => {
      currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
      renderCalendar();
    });
    
    document.getElementById('cal-next').addEventListener('click', () => {
      currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
      renderCalendar();
    });

    // Make selectDate accessible globally for inline onClick
    window.selectDate = (year, month, day) => {
        selectedDate = new Date(year, month, day);
        renderCalendarAgenda();
        renderCalendarGrid();
    }

    const formatDateIso = (date) => {
      const d = new Date(date);
      let month = '' + (d.getMonth() + 1);
      let day = '' + d.getDate();
      const year = d.getFullYear();

      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;

      return [year, month, day].join('-');
    };

    function renderCalendar() {
      document.getElementById('cal-month-year').innerText = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
      renderCalendarGrid();
      renderCalendarAgenda();
    }

    function renderCalendarGrid() {
      const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
      const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();

      const selectedIso = formatDateIso(selectedDate);
      const todaysIso = formatDateIso(new Date());

      let html = '';
      
      for (let i = 0; i < firstDayOfMonth; i++) {
        html += `<div class="h-10"></div>`;
      }
      
      for (let d = 1; d <= daysInMonth; d++) {
        const dateForDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), d);
        const isoForDay = formatDateIso(dateForDay);
        const isSelected = isoForDay === selectedIso;
        const isToday = isoForDay === todaysIso;
        const hasEvents = memories.some(m => m.isoDate === isoForDay && !m.completed);

        let btnClass = `h-10 w-full flex flex-col items-center justify-center rounded-xl text-[15px] transition-all duration-200 relative `;
        if (isSelected) {
            btnClass += 'bg-teal-600 text-white font-medium shadow-md';
        } else {
            btnClass += 'hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-300';
            if (isToday) btnClass += ' border border-teal-500 font-semibold text-teal-600 dark:text-teal-400';
        }

        let dotHtml = '';
        if (hasEvents) {
            dotHtml = `<span class="w-1.5 h-1.5 rounded-full absolute bottom-1.5 ${isSelected ? 'bg-white' : 'bg-teal-500 dark:bg-teal-400'}"></span>`;
        }

        html += `
          <button onclick="selectDate(${dateForDay.getFullYear()}, ${dateForDay.getMonth()}, ${dateForDay.getDate()})" class="${btnClass}">
            <span>${d}</span>
            ${dotHtml}
          </button>
        `;
      }

      document.getElementById('cal-grid').innerHTML = html;
    }

    function renderCalendarAgenda() {
      document.getElementById('cal-selected-date-text').innerText = selectedDate.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
      
      const selectedIso = formatDateIso(selectedDate);
      const eventsOnSelectedDay = memories.filter(m => m.isoDate === selectedIso);

      let html = '';
      if (eventsOnSelectedDay.length > 0) {
        html += `<div class="space-y-3">`;
        eventsOnSelectedDay.forEach(item => {
          const baseClass = item.completed 
            ? 'opacity-50 hover:opacity-100 bg-slate-50 dark:bg-slate-800/40 border-slate-100 dark:border-slate-800' 
            : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 hover:shadow-md';
          
          let iconHtml = `
            <button onclick="toggleMemory('${item.id}')" class="mt-0.5 mr-3 text-teal-600 dark:text-teal-500 hover:text-teal-400 transition-colors flex-shrink-0 focus:outline-none">
              ${item.completed ? `<span class="text-teal-500">${SVG_CHECKED}</span>` : `<span class="text-slate-300 dark:text-slate-600 hover:text-teal-400 dark:hover:text-teal-400 transition-colors">${SVG_CIRCLE}</span>`}
            </button>
          `;

          const textClass = item.completed ? 'line-through text-slate-500 dark:text-slate-400' : 'text-slate-800 dark:text-slate-200';
          let dateHtml = '';
          if (item.dueDate) {
            dateHtml = `
              <div class="flex items-center text-xs font-medium text-slate-400 dark:text-slate-400 mt-2 space-x-1.5 bg-slate-50 dark:bg-slate-700/50 inline-flex px-2 py-0.5 rounded-md transition-colors duration-300">
                ${SVG_CLOCK}
                <span>${escapeHtml(item.dueDate)}</span>
              </div>
            `;
          }

          html += `
            <div class="flex items-start p-4 rounded-2xl border shadow-sm transition-colors duration-300 ${baseClass}">
              ${iconHtml}
              <div class="flex-1 min-w-0 pr-2">
                <p class="text-[15px] leading-snug break-words transition-colors duration-300 ${textClass}">
                  ${escapeHtml(item.content)}
                </p>
                ${dateHtml}
              </div>
            </div>
          `;
        });
        html += `</div>`;
      } else {
        html = `
          <div class="text-center text-slate-400 dark:text-slate-600 mt-8 transition-colors duration-300 text-opacity-50">
            <div class="flex justify-center mb-3 text-slate-300 dark:text-slate-600">${SVG_CALENDAR_EMPTY}</div>
            <p class="text-sm">No events scheduled for this day.</p>
          </div>
        `;
      }
      
      document.getElementById('cal-agenda-content').innerHTML = html;
    }

    // Utilities
    function escapeHtml(unsafe) {
        return (unsafe || '').toString()
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    // Init App display
    renderChat();
    
  </script>
</body>
</html>
